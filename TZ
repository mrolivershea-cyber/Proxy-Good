üìò –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï

–ü—Ä–æ–µ–∫—Ç: Tor-SOCKS Farm Automation

–¶–µ–ª—å: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—É–ª–∞ Tor-–Ω–æ–¥ (–º–∏–Ω–∏–º—É–º 50, –º–∞—Å—à—Ç–∞–± –¥–æ 500) –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Linux (Ubuntu 22.04+), –∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç SOCKS5-–ø—Ä–æ–∫—Å–∏.
–ü–æ–¥–¥–µ—Ä–∂–∫–∞: —Ä–æ—Ç–∞—Ü–∏—è –Ω–æ–¥ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –≤—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã –≤—ã—Ö–æ–¥–∞, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ DNS/IPv6, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ CLI –∏ systemd.

‚∏ª

1. –û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
	1.	–û–°: Ubuntu 22.04 LTS / 24.04 LTS.
	2.	–Ø–∑—ã–∫–∏/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: Bash (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å POSIX), systemd, iptables.
	3.	–í—Å–µ –ø—É—Ç–∏, –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ø–æ—Ä—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø—É–Ω–∫—Ç–∞–º –Ω–∏–∂–µ.
	4.	–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è, –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.
	5.	–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
	‚Ä¢	–º–∏–Ω–∏–º—É–º 50 –∞–∫—Ç–∏–≤–Ω—ã—Ö Tor-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤;
	‚Ä¢	–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ 500;
	‚Ä¢	–ø–æ –æ–¥–Ω–æ–º—É SOCKS5-—ç–Ω–¥–ø–æ–∏–Ω—Ç—É —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –Ω–∞ –∫–∞–∂–¥—ã–π Tor-–∏–Ω—Å—Ç–∞–Ω—Å.
	6.	–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è DNS –∏ IPv6 (–Ω–∏–∫–∞–∫–∏—Ö —É—Ç–µ—á–µ–∫).

‚∏ª

2. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

/opt/tor-socks-farm/
 ‚îú‚îÄ scripts/
 ‚îÇ   ‚îú‚îÄ install.sh
 ‚îÇ   ‚îú‚îÄ deploy_tor_instances.sh
 ‚îÇ   ‚îú‚îÄ deploy_3proxy_endpoints.sh
 ‚îÇ   ‚îú‚îÄ rotate.sh
 ‚îÇ   ‚îú‚îÄ enable_rotation.sh
 ‚îÇ   ‚îî‚îÄ tor_iptables_apply.sh
 ‚îú‚îÄ systemd/
 ‚îÇ   ‚îú‚îÄ tor@.service
 ‚îÇ   ‚îú‚îÄ 3proxy@.service
 ‚îÇ   ‚îú‚îÄ rotate.service
 ‚îÇ   ‚îî‚îÄ rotate.timer
 ‚îú‚îÄ config/
 ‚îÇ   ‚îú‚îÄ torfarm.env
 ‚îÇ   ‚îú‚îÄ countries.map
 ‚îÇ   ‚îú‚îÄ users.csv
 ‚îÇ   ‚îî‚îÄ control.password
 ‚îú‚îÄ 3proxy/
 ‚îÇ   ‚îî‚îÄ instance.cfg.tpl
 ‚îî‚îÄ firewall/
     ‚îî‚îÄ hardening.sh


‚∏ª

3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ü–∞—Ä–∞–º–µ—Ç—Ä	–ó–Ω–∞—á–µ–Ω–∏–µ	–û–ø–∏—Å–∞–Ω–∏–µ
MIN_INSTANCES	50	—Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
MAX_INSTANCES	500	–ª–∏–º–∏—Ç
BASE_SOCKS_PORT	9000	–ª–æ–∫–∞–ª—å–Ω—ã–µ SOCKS 9001..
BASE_CTRL_PORT	9100	ControlPort 9101..
BASE_DNS_PORT	9200	DNSPort 9201..
BASE_TRANS_PORT	9300	TransPort 9301..
BASE_PUBLIC_PORT	20000	–≤–Ω–µ—à–Ω–∏–µ SOCKS 20001..
ROTATE_EVERY_MIN	30	–∏–Ω—Ç–µ—Ä–≤–∞–ª —Ä–æ—Ç–∞—Ü–∏–∏ (–º–∏–Ω.)
DEFAULT_COUNTRY	*	–±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω—ã


‚∏ª

4. –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

4.1 config/torfarm.env

–•—Ä–∞–Ω–∏—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å–º. –ø. 3).

4.2 config/countries.map

–§–æ—Ä–º–∞—Ç:

001=us
002=de
003=*
...

* ‚Äì –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã.

4.3 config/users.csv

–§–æ—Ä–º–∞—Ç CSV —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º:

instance,user,password
001,user001,pass001
002,user002,pass002
...

4.4 config/control.password

–°–æ–¥–µ—Ä–∂–∏—Ç plain-—Ç–µ–∫—Å—Ç –ø–∞—Ä–æ–ª—å –¥–ª—è Tor ControlPort.
–°—Ü–µ–Ω–∞—Ä–∏–π deploy_tor_instances.sh —Å–æ–∑–¥–∞—ë—Ç –µ–≥–æ —Ö—ç—à –∏ –≤–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –∫–∞–∂–¥—ã–π torrc.instanceNNN.

‚∏ª

5. –°–∫—Ä–∏–ø—Ç—ã (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

5.1 scripts/install.sh
	‚Ä¢	–ü—Ä–æ–≤–µ—Ä—è–µ—Ç root-–ø—Ä–∞–≤–∞.
	‚Ä¢	–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–∞–∫–µ—Ç—ã:

apt-get install -y tor 3proxy netcat-traditional jq


	‚Ä¢	–°–æ–∑–¥–∞—ë—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

useradd -r -s /usr/sbin/nologin debian-tor || true
useradd -r -s /usr/sbin/nologin proxy || true


	‚Ä¢	–ö–æ–ø–∏—Ä—É–µ—Ç systemd-—é–Ω–∏—Ç—ã –≤ /etc/systemd/system/.
	‚Ä¢	–í—ã–∫–ª—é—á–∞–µ—Ç IPv6 –≤ /etc/sysctl.conf.
	‚Ä¢	–í—ã–ø–æ–ª–Ω—è–µ—Ç systemctl daemon-reload.

5.2 scripts/deploy_tor_instances.sh

–ê—Ä–≥—É–º–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50).
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ 001..COUNT:
	1.	–°–æ–∑–¥–∞—ë—Ç /var/lib/tor/instanceNNN (–≤–ª–∞–¥. debian-tor).
	2.	–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç /etc/tor/torrc.instanceNNN —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

DataDirectory /var/lib/tor/instanceNNN
SocksPort 127.0.0.1:900N
ControlPort 127.0.0.1:910N
HashedControlPassword <HASH>
DNSPort 127.0.0.1:920N
TransPort 127.0.0.1:930N
Log notice file /var/log/tor/instanceNNN.log
ClientOnly 1
AvoidDiskWrites 1
VirtualAddrNetworkIPv4 10.192.0.0/10
AutomapHostsOnResolve 1


	3.	–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —é–Ω–∏—Ç tor@NNN:

systemctl enable --now tor@NNN


	4.	–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å (active (running)).

5.3 scripts/deploy_3proxy_endpoints.sh

–ê—Ä–≥—É–º–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞:
	1.	–ë–µ—Ä—ë—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ users.csv.
	2.	–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç /etc/3proxy/instanceNNN.cfg –∏–∑ —à–∞–±–ª–æ–Ω–∞ 3proxy/instance.cfg.tpl:

auth strong
users <user>:CL:<password>
socks -p<public_port> -a
parent 1000 socks5 127.0.0.1 <local_socks>


	3.	–ó–∞–ø—É—Å–∫–∞–µ—Ç systemctl enable --now 3proxy@NNN.

5.4 scripts/rotate.sh
	‚Ä¢	–ß–∏—Ç–∞–µ—Ç countries.map –∏ control.password.
	‚Ä¢	–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ torrc.instanceNNN –≤—ã–ø–æ–ª–Ω—è–µ—Ç —á–µ—Ä–µ–∑ nc:

AUTHENTICATE "<password>"
SETCONF ExitNodes={xx} StrictNodes=1
SIGNAL NEWNYM
QUIT


	‚Ä¢	–ï—Å–ª–∏ *, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SETCONF ExitNodes= (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ).
	‚Ä¢	–õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ stdout.

5.5 scripts/enable_rotation.sh
	‚Ä¢	–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç OnUnitActiveSec=${ROTATE_EVERY_MIN}m –≤ /etc/systemd/system/rotate.timer.
	‚Ä¢	–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç–∞–π–º–µ—Ä:

systemctl enable --now rotate.timer



5.6 scripts/tor_iptables_apply.sh
	‚Ä¢	–°–æ–∑–¥–∞—ë—Ç –±—ç–∫–∞–ø –ø—Ä–∞–≤–∏–ª:
iptables-save > /root/iptables.backup.$(date +%s)
	‚Ä¢	–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è debian-tor.
	‚Ä¢	–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞:

iptables -I OUTPUT -p udp --dport 53 -m owner ! --uid-owner $TOR_UID -j REJECT
iptables -I OUTPUT -p tcp --dport 53 -m owner ! --uid-owner $TOR_UID -j REJECT


	‚Ä¢	(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) REDIRECT –≤–µ—Å—å TCP –≤ TransPort 9301, –∫—Ä–æ–º–µ SSH.
	‚Ä¢	–í—ã–≤–æ–¥–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –æ—Ç–∫–∞—Ç—É:
iptables-restore < /root/iptables.backup.<timestamp>.

‚∏ª

6. systemd —é–Ω–∏—Ç—ã

6.1 /etc/systemd/system/tor@.service

[Unit]
Description=Tor instance %i
After=network-online.target
[Service]
User=debian-tor
Group=debian-tor
ExecStart=/usr/bin/tor -f /etc/tor/torrc.instance%i
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target

6.2 /etc/systemd/system/3proxy@.service

[Unit]
Description=3proxy endpoint %i
After=network-online.target
[Service]
User=proxy
Group=proxy
ExecStart=/usr/bin/3proxy /etc/3proxy/instance%i.cfg
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target

6.3 /etc/systemd/system/rotate.service

[Unit]
Description=Rotate Tor identities
[Service]
Type=oneshot
ExecStart=/opt/tor-socks-farm/scripts/rotate.sh

6.4 /etc/systemd/system/rotate.timer

[Unit]
Description=Periodic rotation timer
[Timer]
OnBootSec=5m
OnUnitActiveSec=30m
Unit=rotate.service
[Install]
WantedBy=timers.target


‚∏ª

7. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
	1.	IPv6 –≤—ã–∫–ª—é—á–µ–Ω.
	2.	–í—Å–µ DNS-–∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é debian-tor.
	3.	–ü—É–±–ª–∏—á–Ω—ã–µ SOCKS-–ø–æ—Ä—Ç—ã —Å–ª—É—à–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ 3proxy.
	4.	–ù–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è bind Tor –Ω–∞ 0.0.0.0.
	5.	–î–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è rollback –¥–ª—è iptables.

‚∏ª

8. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
	1.	–ü–æ—Å–ª–µ install.sh –∏ deploy_tor_instances.sh 50:
	‚Ä¢	–ê–∫—Ç–∏–≤–Ω–æ 50 —é–Ω–∏—Ç–æ–≤ tor@NNN ( systemctl list-units | grep tor@ ).
	‚Ä¢	–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ 127.0.0.1:900N.
	2.	–ü–æ—Å–ª–µ deploy_3proxy_endpoints.sh 50:
	‚Ä¢	–ê–∫—Ç–∏–≤–Ω–æ 50 —é–Ω–∏—Ç–æ–≤ 3proxy@NNN.
	‚Ä¢	–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SERVER_IP:200N + –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –¥–∞—ë—Ç Tor IP –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
	3.	–ü—Ä–∏ rotate.sh: –º–µ–Ω—è–µ—Ç—Å—è Tor exit IP; –ø—Ä–∏ countries.map —É–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ ‚Äî –≤—ã—Ö–æ–¥–Ω–æ–π IP —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç.
	4.	–¢–µ—Å—Ç –Ω–∞ DNS/IPv6 leak –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω—É–ª–µ–≤—ã–µ —É—Ç–µ—á–∫–∏.
	5.	–ò–Ω—Ç–µ—Ä–≤–∞–ª —Ä–æ—Ç–∞—Ü–∏–∏ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ config/torfarm.env.
	6.	–ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ –¥–æ 500 –Ω–æ–¥ –≤—Å–µ —é–Ω–∏—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.

‚∏ª

9. –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

bash /opt/tor-socks-farm/scripts/install.sh
bash /opt/tor-socks-farm/scripts/deploy_tor_instances.sh 50
bash /opt/tor-socks-farm/scripts/deploy_3proxy_endpoints.sh 50
bash /opt/tor-socks-farm/scripts/enable_rotation.sh
bash /opt/tor-socks-farm/firewall/hardening.sh


‚∏ª

10. –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
	‚Ä¢	–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–∫—Ç–∏–≤–Ω–æ N Tor-–Ω–æ–¥ (50 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –¥–æ 500).
	‚Ä¢	–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ SOCKS5 —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 20001..20050.
	‚Ä¢	–ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç Tor —Ä–æ—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ ControlPort (NEWNYM + ExitNodes={country}).
	‚Ä¢	–ù–µ—Ç —É—Ç–µ—á–µ–∫ DNS –∏–ª–∏ IPv6.

‚∏ª
